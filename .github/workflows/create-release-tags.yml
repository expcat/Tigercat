name: Create Release Tags

on:
  workflow_dispatch:

permissions:
    contents: write

jobs:
    version-and-tag:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 18

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.26.2

            - name: Configure git
              run: |
                  git config user.name "github-actions"
                  git config user.email "github-actions@github.com"

            - name: Check packages changes
              id: packages_changed
              run: |
                  set -e
                  LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
                  if [[ -z "$LAST_TAG" ]]; then
                    RANGE="HEAD"
                  else
                    RANGE="${LAST_TAG}..HEAD"
                  fi

                  echo "LAST_TAG=${LAST_TAG}"
                  echo "RANGE=${RANGE}"
                  echo "CHANGED_FILES:"
                  git diff --name-only "$RANGE" || true

                  if git diff --name-only "$RANGE" | grep -q '^packages/'; then
                    echo "changed=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "changed=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Version packages and create tags
              if: steps.packages_changed.outputs.changed == 'true'
              run: |
                  LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
                  if [[ -z "$LAST_TAG" ]]; then
                    BASE_VERSION=$(node -p "require('./packages/core/package.json').version")
                    COMMIT_COUNT=$(git rev-list --count HEAD)
                  else
                    BASE_VERSION=${LAST_TAG#v}
                    COMMIT_COUNT=$(git rev-list --count "${LAST_TAG}..HEAD")
                  fi

                  echo "BASE_VERSION=${BASE_VERSION}"
                  echo "COMMIT_COUNT=${COMMIT_COUNT}"

                  if [[ "$COMMIT_COUNT" -eq 0 ]]; then
                    echo "No new commits since last tag"
                    exit 0
                  fi

                  IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"
                  NEW_PATCH=$((PATCH + COMMIT_COUNT))
                  VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
                  TAG="v${VERSION}"

                  echo "NEXT_TAG=${TAG}"

                  if git rev-parse "${TAG}" >/dev/null 2>&1; then
                    echo "Tag already exists: ${TAG}"
                    exit 1
                  fi

                  pnpm -r --filter "./packages/**" version "${VERSION}" --no-git-tag-version

                  if [[ -n "$(git status --porcelain)" ]]; then
                    git add packages/*/package.json
                    git commit -m "chore(release): ${TAG}"
                  fi

                  git tag -a "${TAG}" -m "chore(release): ${TAG}"
                  git push origin "${TAG}"
