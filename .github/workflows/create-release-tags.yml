name: Create Release Tags

on:
  workflow_dispatch:

permissions:
    contents: write

jobs:
    version-and-tag:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.26.2

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 18
                  cache: pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Configure git
              run: |
                  git config user.name "github-actions"
                  git config user.email "github-actions@github.com"

            - name: Check packages changes
              id: packages_changed
              run: |
                  set -e
                  LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
                  if [[ -z "$LAST_TAG" ]]; then
                    RANGE="HEAD"
                  else
                    RANGE="${LAST_TAG}..HEAD"
                  fi

                  if git diff --name-only "$RANGE" | grep -q '^packages/'; then
                    echo "changed=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "changed=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Version packages and create tags
              if: steps.packages_changed.outputs.changed == 'true'
              run: |
                  pnpm changeset version
                  if [[ -n "$(git status --porcelain)" ]]; then
                    git add -A
                    git commit -m "chore(release): version packages"
                    VERSION=$(node -p "require('./packages/core/package.json').version")
                    TAG="v${VERSION}"
                    git tag "${TAG}"
                    git push --follow-tags
                  else
                    echo "No changesets to release"
                  fi
